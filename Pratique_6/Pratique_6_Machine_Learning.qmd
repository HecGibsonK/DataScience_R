---
title: "Pratique_6_Machine_Learning_R"
author: "Dr Hector Gibson Kinmanhon HOUANKPO (PhD)"
format: html
editor: visual
---

```{r}
#| echo: false
library(randomForest) # Bibliothèque de foret aleatoire
library(ggplot2)    # Visualisation des données
library(readxl)     # Bibliothèque de manipulation de données dans Excel
library(dplyr)      # Bibliothèque de manipulation de données statistiques
library(psych)     # Bibliothèque de statistiques descriptives
library(car)      # Bibliothèque de modèle de régression
library(caret)    # Bibliothèque pour Machine learning
library(pROC)     # Bibliothèque pour l'évaluation des modèles 
```

# [**Régression logistique en R**]{.underline}

```{r}
#| echo: false
Data = read.table(file.choose(), sep=",", header = T)
```

```{r}
#| echo: false
# Duplication de la base de donnees
Mydata <- Data
```

### [**Voir les types de donnees de "Clients"**]{.underline}

```{r}
#| echo: false
sapply(Mydata, class)
```

### [**La structure de la base de donnees**]{.underline}

```{r}
#| echo: false
str(Mydata)
```

# [**Preprocessing**]{.underline}

## [**Resume descriptif de la base de donnee**]{.underline}

```{r}
#| echo: false
summary(Mydata)
```

### Suppression [**des lignes contenent des valeurs manquantes (recommander)**]{.underline}

```{r}
#| echo: false
# Mydata_new <- na.omit(Mydata) 
```

### [**Imputation des valeurs manquantes par le moyenne(Pas recommander)**]{.underline}

```{r}
#| echo: false
Mydata_new = Mydata 
Mydata_new$Age[is.na(Mydata_new$Age)] <- mean(Mydata_new$Age, na.rm = T)
```

#### [**Conversion de certaines variable en "Factor"**]{.underline}

```{r}
#| echo: false
Mydata_new$Survived <- as.factor(Mydata_new$Survived)
Mydata_new$Sex <- as.factor(Mydata_new$Sex)
Mydata_new$Pclass <- as.factor(Mydata_new$Pclass)
str(Mydata_new)
```

# [**Diviser la base de données deux**]{.underline}

-   La base d'apprentissage 70% de la base totale

-   La base test: 30%

### [**Choix des variables pertinantes**]{.underline}

```{r}
names(Mydata_new)
```

```{r}

Mydata_New <- subset(Mydata_new, select = c(Survived,Pclass,Sex,Age,SibSp,Parch,Fare)) # Sélectionner et/ou supprimer des colonnes d'une table

#Mydata_New <- within(Mydata, rm(PassengerId, Name, Ticket, Cabin,Embarked))  # supprimer des colonnes d'une table 

#Mydata_New <- Mydata_new[, c(2,3,5,6,7,8,10)]

names(Mydata_New)
```

```{r}
set.seed(123)# Assurer la reproductibilité de votre 
index <- createDataPartition(Mydata_New$Survived, p=0.7, list=F)
head(index)
```

```{r}
# autre option
index1 <- sample(1:nrow(Mydata_New), 0.7*nrow(Mydata_New))
head(index1)
```

```{r}
Mydata_train <- Mydata_New[index, ]
Mydata_test <- Mydata_New[-index,]

names(Mydata_train)
```

# [**Regression logistique**]{.underline}

```{r}
model_logistique <- glm(Survived ~ ., family = binomial, data = Mydata_train)

model_logistique2 <- glm(Survived ~ Pclass + Sex + Age + SibSp + Parch + Fare, family = binomial, data = Mydata_train)
```

```{r}
# Stocker le modèle
saveRDS(model_logistique, "/Users/natachanjongwayepnga/Documents/GitHub/LeCoinStat/R_Pour_La_Datascience/Jour7/model_logistique_final.rds")
```

### [**Verification des residus**]{.underline}

```{r}
summary(model_logistique)
```

```{r}
anova(model_logistique, test = "Chisq")
```

```{r}
# Significativité globale du modèle  ??????
 G2 = model_logistique$null.deviance-model_logistique$deviance
 
  1-pchisq(G2,df=1)
```

# [**Prédiction sur la base de donnee "train"**]{.underline}

#### [**Calcul des scores de prediction (Probabilites) sur les donnees d'entrainement**]{.underline}

```{r}
# Calcul des scores de prediction (Probabilites)
prediction_train <- predict(model_logistique, type = "response")
prediction_train[1:5]
```

#### [**Evaluation des modèles par courbe ROC (Train)**]{.underline}

```{r}
# Package pour l'évaluation des modèles
#library(pROC)
Roc_train <- roc(response = Mydata_train$Survived, predictor = prediction_train)
Roc_train

plot(Roc_train, main="Courbe ROC")
```

```{r}
AUC_train <- auc(Roc_train)
AUC_train
```

# [**Prédiction sur la base de donnee "Test"**]{.underline}

#### [**Calcul des scores de prediction (Probabilites) sur les donnees test**]{.underline}

```{r}
prediction_test <- predict(model_logistique, newdata = Mydata_test[,-1], type = "response")
prediction_test[1:5]
```

#### [**Evaluation des modèles par courbe ROC(Test)**]{.underline}

```{r}
Roc_test <- roc(response = Mydata_test$Survived, predictor = prediction_test)
Roc_test

plot(Roc_test, main="Courbe ROC")
```

```{r}
AUC_test <- auc(Roc_test)
AUC_test
```

# Forêts aléatoires

```{r}
#install.packages("randomForest")
#library(randomForest)
model_rf <- randomForest(Survived ~ ., data=Mydata_train, importance=TRUE,
                        ntree=500)
model_rf
```

```{r}
# Stocker le modèle
saveRDS(model_rf, "/Users/natachanjongwayepnga/Documents/GitHub/LeCoinStat/R_Pour_La_Datascience/Jour7/model_randomforest.rds")
```

#### [**Importance des variables**]{.underline}

```{r}
# Importance des variables
varImp(model_rf)
```

```{r}
varImpPlot(model_rf)
```

```{r}
plot(model_rf)
```

# [**Prédiction sur la base de donnee "Train"**]{.underline}

```{r}
prediction_rf_train <-  predict(model_rf, type = "prob")[,2]

#prediction_rf_train <-  predict(model_rf, type = "response")

head(prediction_rf_train)
```

```{r}
#Vérifier le type des variables de Mydata_train et prediction_rf_train
str(Mydata_train$Survived)
str(prediction_rf_train)
```

```{r}
#Mydata_train$Survived <- as.numeric(as.character(Mydata_train$Survived))
#prediction_rf_train <- as.numeric(as.character(prediction_rf_train))
```

```{r}
roc_rf_train <- roc(Mydata_train$Survived, prediction_rf_train, levels=c("0", "1"))

plot(roc_rf_train, main="Courbe ROC")
```

```{r}
AUC_rf_train <- auc(roc_rf_train)
AUC_rf_train
```

# [**Prédiction sur la base de donnee "Test"**]{.underline}

```{r}
prediction_rf_test <- predict(model_rf, newdata = Mydata_test[,-1], type = "prob")[,2]

#prediction_rf_test <- predict(model_rf, newdata = Mydata_test[,-1], type = "response")

prediction_rf_test[1:5]
```

```{r}
#Vérifier le type des variables de Mydata_train et prediction_rf_train
str(Mydata_test$Survived)
str(prediction_rf_test)
```

```{r}
#Mydata_test$Survived <- as.numeric(as.character(Mydata_test$Survived))
#prediction_rf_test <- as.numeric(as.character(prediction_rf_test))
```

```{r}
roc_rf_test <- roc(Mydata_test$Survived, prediction_rf_test, levels=c("0", "1"))

plot(roc_rf_test, main="Courbe ROC")
```

```{r}
AUC_rf_test <- auc(roc_rf_test)
AUC_rf_test
```

## [Optimisation des paramètres de la forêt aléatoire]{.underline}

-   Définition des paramètres de validation croisée "trainControl"

-   Grid de paramètres à tester "expand.grid"

-   Entraînement du modèle avec validation croisée et recherche des meilleurs hyperparamètres "train"

```{r}
# Définition des paramètres de validation croisée
control <- trainControl(method="cv", number=5, search="grid") 
              # number = 5 <- nombre d'iteration

# Grid de paramètres à tester
tunegrid <- expand.grid(.mtry=c(1, 2, 3, 4, 5))

# Entraînement du modèle avec validation croisée et recherche des meilleurs hyperparamètres
rf_model <- train(Survived ~ ., data=Mydata_train, method="rf", trControl=control, tuneGrid=tunegrid, ntree=500)
```

### [**Meilleurs paramètres trouvés**]{.underline}

```{r}
# Meilleurs paramètres trouvés
print(rf_model$bestTune)
```

### [**Entraînement direct avec randomForest pour accès à l'erreur OOB**]{.underline}

```{r}
# Entraînement direct avec randomForest pour accès à l'erreur OOB
rf_model_direct <- randomForest(Survived ~ ., data=Mydata_train, mtry=rf_model$bestTune$mtry, ntree=500)


plot(rf_model_direct)

# Importance des variables
importance <- varImp(rf_model, scale=FALSE)
print(importance)
```

### [**Prédiction sur l'ensemble de test**]{.underline}

```{r}

# Prédiction sur l'ensemble de test
predictions <- predict(rf_model, newdata=Mydata_test)
head(predictions)
```

```{r}
str(predictions)
```

```{r}
# Calcul de l'AUC et tracé de la courbe ROC
prob_predictions <- predict(rf_model, newdata=Mydata_test, type="raw")
head(prob_predictions)
```

```{r}
roc_MD <- roc(Mydata_test$Survived, prob_predictions)

plot(roc_MD, main="Courbe ROC")
```

```{r}
AUC_MD <- auc(roc_MD)
AUC_MD
```
